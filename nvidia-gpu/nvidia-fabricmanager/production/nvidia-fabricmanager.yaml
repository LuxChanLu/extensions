# https://docs.nvidia.com/datacenter/tesla/pdf/fabric-manager-user-guide.pdf
name: nvidia-fabricmanager
container:
  entrypoint: /usr/bin/nvidia-fabricmanager-wrapper
  mounts:
    # device files
    - source: /dev
      destination: /dev
      type: bind
      options:
        - rshared
        - rbind
        - rw
    # shared libraries
    - source: /lib64
      destination: /lib64
      type: bind
      options:
        - bind
        - ro
    # shared libraries
    - source: /usr/local/glibc
      destination: /usr/local/glibc
      type: bind
      options:
        - bind
        - ro
    # service state file
    # * nvlsm:
    #   - pid file that can't be disabled
    #   - unix socket /var/run/nvidia-fabricmanager/fm_sm_ipc.socket
    #     can't be changed, path is hardcoded into fabricmanager
    # * fabricmanager
    #   - state file
    #   - database files
    - source: /var/run/nvidia-fabricmanager
      destination: /var/run
      type: bind
      options:
        - rshared
        - rbind
        - rw
    # service cache file
    # * nvlsm: database files
    - source: /var/cache/nvidia-fabricmanager
      destination: /var/cache
      type: bind
      options:
        - rshared
        - rbind
        - rw
    # service log files
    # * nvlsm:
    #   - mandatory dump files hardcoded to /var/log/<file>, so /var/log must be writable
    - source: /var/log/nvidia-fabricmanager
      destination: /var/log
      type: bind
      options:
        - rshared
        - rbind
        - rw
depends:
  - service: cri
  # we need to depend on udevd so that the nvidia device files are created
  - service: udevd
  - path: /sys/bus/pci/drivers/nvidia
restart: always
